<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Just looking for stocks</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --border: #d7deea;
      --text: #1b2333;
      --muted: #5a667a;
      --accent: #0052cc;
      --danger: #c62828;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 14px 40px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .title { font-size: 22px; font-weight: 700; }
    .muted { color: var(--muted); font-size: 13px; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .controls {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      margin-bottom: 8px;
    }
    .search-box { display: flex; gap: 6px; }
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
    }
    button, .chip {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #eef2f8;
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
    }
    button.primary { background: var(--accent); color: white; border-color: var(--accent); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .chip { display: inline-flex; gap: 6px; align-items: center; background: #f2f5fb; }
    .range-tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .range-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 7px 8px;
      text-align: left;
    }
    th { background: #f1f4fa; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; }
    .error { color: var(--danger); margin-top: 6px; font-size: 14px; }
    .chart-area { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-top: 10px; }
    canvas { width: 100% !important; height: 320px !important; cursor: grab; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }
    .hint { font-size: 12px; color: var(--muted); }
    .ghost-btn { background: #f6f8fc; border-color: var(--border); padding: 6px 10px; font-weight: 600; }
    .inline-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title">Just looking for stocks</div>
      <div class="muted">Simple tables, fresh data each reload.</div>
    </header>

    <div class="panel">
      <div class="controls">
        <form id="searchForm" class="search-box">
          <input id="tickerInput" type="text" placeholder="e.g., AAPL or apple" list="symbolList" />
          <datalist id="symbolList"></datalist>
          <button class="primary" type="submit">Load</button>
        </form>
        <div class="inline-controls">
          <div class="range-tabs" id="rangeTabs">
            <button class="range-btn" data-range="1d">1d</button>
            <button class="range-btn" data-range="1w">1w</button>
            <button class="range-btn active" data-range="1m">1m</button>
            <button class="range-btn" data-range="3m">3m</button>
            <button class="range-btn" data-range="6m">6m</button>
            <button class="range-btn" data-range="ytd">YTD</button>
            <button class="range-btn" data-range="1y">1y</button>
            <button class="range-btn" data-range="2y">2y</button>
            <button class="range-btn" data-range="5y">5y</button>
            <button class="range-btn" data-range="10y">10y</button>
            <button class="range-btn" data-range="all">All</button>
          </div>
          <select id="intervalSelect">
            <option value="auto" selected>Auto interval</option>
            <option value="1m">1m</option>
            <option value="2m">2m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="30m">30m</option>
            <option value="1h">1h</option>
            <option value="1d">1d</option>
            <option value="5d">5d</option>
            <option value="1wk">1wk</option>
            <option value="1mo">1mo</option>
            <option value="3mo">3mo</option>
          </select>
        </div>
      </div>
      <div id="quickPicks" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px;"></div>
      <div id="error" class="error" style="display:none;"></div>

      <div class="grid">
        <div>
          <div class="muted">Stock info</div>
          <table>
            <tbody>
              <tr><th>Symbol</th><td id="infoSymbol">—</td></tr>
              <tr><th>Name</th><td id="infoName">—</td></tr>
              <tr><th>Sector</th><td id="infoSector">—</td></tr>
              <tr><th>Industry</th><td id="infoIndustry">—</td></tr>
              <tr><th>Current Price</th><td id="infoPrice">—</td></tr>
              <tr><th>Market Cap</th><td id="infoMarketCap">—</td></tr>
              <tr><th>52W Low / High</th><td id="info52w">—</td></tr>
              <tr><th>Website</th><td id="infoWebsite">—</td></tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="muted">Prediction summary</div>
          <table>
            <tbody>
              <tr><th>Next predicted close</th><td id="predictionValue">—</td></tr>
              <tr><th>RMSE (USD)</th><td id="rmseValue">—</td></tr>
              <tr><th>Range in view</th><td id="priceMeta">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="chart-header">
          <div class="muted">Price chart (Close)</div>
          <div class="hint">Scroll/pinch to zoom • Drag to pan • Shift+drag to box-zoom • Double-click/reset</div>
          <button id="resetPriceZoom" class="ghost-btn" type="button">Reset zoom</button>
        </div>
        <div class="chart-area"><canvas id="priceChart"></canvas></div>
      </div>

      <div style="margin-top:10px;">
        <div class="chart-header">
          <div class="muted">Validation (Actual vs Predicted)</div>
          <div class="hint">Scroll/pinch to zoom • Drag to pan • Shift+drag to box-zoom • Double-click/reset</div>
          <button id="resetPredZoom" class="ghost-btn" type="button">Reset zoom</button>
        </div>
        <div class="chart-area"><canvas id="predChart"></canvas></div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; margin-top:6px;">
          <div class="muted" id="predRowsMeta">Summary view</div>
          <button id="togglePredRows" class="ghost-btn" type="button">Show all</button>
        </div>
        <table id="predTable">
          <thead>
            <tr><th>Date</th><th>Actual Close</th><th>Predicted</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div class="muted">History (Open/High/Low/Close/Volume)</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <div class="muted" id="historyRowsMeta">Summary view</div>
            <button id="toggleHistoryRows" class="ghost-btn" type="button">Show all</button>
          </div>
        </div>
        <table id="historyTable">
          <thead>
            <tr><th>Date</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Volume</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const state = {
      ticker: "AAPL",
      range: "1m",
      interval: "auto",
      showFullHistory: false,
      showFullPred: false,
      historyData: [],
      validationData: [],
    };
    if (window.ChartZoom) {
      Chart.register(window.ChartZoom);
    }
    const crosshairPlugin = {
      id: "crosshair",
      afterDatasetsDraw(chart) {
        const enabled = chart.options?.plugins?.crosshair?.enabled;
        if (!enabled) return;
        const active = chart.getActiveElements();
        if (!active || !active.length) return;
        const { ctx, chartArea } = chart;
        const { left, right, top, bottom } = chartArea;
        const { element } = active[0];
        const x = element.x;
        const y = element.y;
        const { datasetIndex, index } = active[0];
        const ds = chart.data.datasets?.[datasetIndex];
        const val = ds?.data?.[index];
        const price = typeof val === "object" && val !== null ? val.y ?? val : val;
        const label = chart.data.labels?.[index];
        ctx.save();
        ctx.setLineDash([4, 4]);
        ctx.lineWidth = 1;
        ctx.strokeStyle = "#94a3b8";
        ctx.beginPath();
        ctx.moveTo(x, top);
        ctx.lineTo(x, bottom);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(right, y);
        ctx.stroke();
        if (label) {
          const labelText = String(label);
          const padding = 6;
          const height = 20;
          ctx.font = "12px Inter, system-ui";
          const width = ctx.measureText(labelText).width + padding * 2;
          const lx = Math.min(Math.max(x - width / 2, left + 2), right - width - 2);
          const ly = top + 4;
          ctx.fillStyle = "#0f172a";
          ctx.strokeStyle = "#e2e8f0";
          ctx.lineWidth = 1;
          ctx.beginPath();
          if (typeof ctx.roundRect === "function") {
            ctx.roundRect(lx, ly, width, height, 4);
          } else {
            ctx.rect(lx, ly, width, height);
          }
          ctx.fillStyle = "#f8fafc";
          ctx.fill();
          ctx.stroke();
          ctx.fillStyle = "#0f172a";
          ctx.fillText(labelText, lx + padding, ly + height - 6);
        }
        if (price !== undefined) {
          const txt = typeof price === "number" ? price.toLocaleString("en-US", { maximumFractionDigits: 2 }) : String(price);
          const padding = 6;
          const height = 20;
          ctx.font = "12px Inter, system-ui";
          const width = ctx.measureText(txt).width + padding * 2;
          const rx = right - width - 6;
          const ry = y - height / 2;
          ctx.fillStyle = "#0f172a";
          ctx.strokeStyle = "#e2e8f0";
          ctx.lineWidth = 1;
          ctx.beginPath();
          if (typeof ctx.roundRect === "function") {
            ctx.roundRect(rx, ry, width, height, 4);
          } else {
            ctx.rect(rx, ry, width, height);
          }
          ctx.fillStyle = "#f8fafc";
          ctx.fill();
          ctx.stroke();
          ctx.fillStyle = "#0f172a";
          ctx.fillText(txt, rx + padding, ry + height - 6);
        }
        ctx.restore();
      },
    };
    Chart.register(crosshairPlugin);
    let quickPickList = [];
    let priceChart, predChart;
    let searchTimer = null;
    let searchSeq = 0;
    let activeLoadToken = 0;

    const tickerInput = document.getElementById("tickerInput");
    const rangeTabs = document.getElementById("rangeTabs");
    const intervalSelect = document.getElementById("intervalSelect");
    const toggleHistoryRowsBtn = document.getElementById("toggleHistoryRows");
    const togglePredRowsBtn = document.getElementById("togglePredRows");
    rangeTabs.addEventListener("click", (e) => {
      const btn = e.target.closest(".range-btn");
      if (!btn) return;
      document.querySelectorAll(".range-btn").forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      state.range = btn.dataset.range;
      loadHistory(activeLoadToken, state.ticker, state.range, state.interval);
    });

    intervalSelect.addEventListener("change", () => {
      state.interval = intervalSelect.value;
      loadHistory(activeLoadToken, state.ticker, state.range, state.interval);
    });

    toggleHistoryRowsBtn.addEventListener("click", () => {
      state.showFullHistory = !state.showFullHistory;
      renderHistoryTable(state.historyData);
    });

    togglePredRowsBtn.addEventListener("click", () => {
      state.showFullPred = !state.showFullPred;
      renderPredTable(state.validationData);
    });
    document.getElementById("searchForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const val = tickerInput.value.trim();
      if (!val) return;
      state.ticker = val.toUpperCase();
      loadAll();
    });

    tickerInput.addEventListener("input", (e) => {
      const val = e.target.value.trim();
      clearTimeout(searchTimer);
      if (val.length < 2) {
        searchSeq += 1;
        renderOptions(quickPickList);
        return;
      }
      searchTimer = setTimeout(() => {
        runSearch(val);
      }, 200);
    });

    async function fetchJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      const data = await res.json();
      if (!res.ok || data.error) {
        throw new Error(data.error || "Request failed");
      }
      return data;
    }

    function formatUSD(num) {
      if (num === null || num === undefined || Number.isNaN(num)) return "—";
      return "$" + Number(num).toLocaleString("en-US", { maximumFractionDigits: 2 });
    }

    function setCursor(el, cursor) {
      if (el) el.style.cursor = cursor;
    }

    function zoomOptions(canvas) {
      return {
        pan: { enabled: true, mode: "xy", threshold: 0 },
        zoom: {
          wheel: { enabled: true, speed: 0.05, modifierKey: null },
          pinch: { enabled: true },
          drag: {
            enabled: true,
            modifierKey: "shift",
            mode: "xy",
            borderColor: "#0052cc",
            backgroundColor: "rgba(0,82,204,0.08)",
            threshold: 6,
          },
          mode: "xy",
        },
        limits: {
          x: { min: "original", max: "original" },
          y: { min: "original", max: "original" },
        },
      };
    }

    const panHandlers = new WeakMap();
    function attachPanHandlers(chart, canvas) {
      if (!canvas || !chart || typeof chart.pan !== "function") return;
      const prev = panHandlers.get(canvas);
      if (prev) {
        canvas.removeEventListener("pointerdown", prev.down);
        canvas.removeEventListener("pointermove", prev.move);
        canvas.removeEventListener("pointerup", prev.up);
        canvas.removeEventListener("pointerleave", prev.up);
      }
      let isPanning = false;
      let lastX = 0;
      let lastY = 0;
      let pending = { x: 0, y: 0 };
      let raf = null;
      const flushPan = () => {
        raf = null;
        if (!isPanning) return;
        chart.pan(pending, undefined, "none");
        pending = { x: 0, y: 0 };
      };
      const down = (e) => {
        // Skip if using shift for box-zoom or not primary button.
        if (e.shiftKey || e.button !== 0) return;
        e.preventDefault();
        isPanning = true;
        lastX = e.clientX;
        lastY = e.clientY;
        try {
          canvas.setPointerCapture(e.pointerId);
        } catch (_) {}
        setCursor(canvas, "grabbing");
      };
      const move = (e) => {
        if (!isPanning) return;
        e.preventDefault();
        const dx = e.clientX - lastX;
        const dy = e.clientY - lastY;
        // Dragging right should move the chart view left (invert direction).
        pending.x += dx;
        pending.y += dy;
        lastX = e.clientX;
        lastY = e.clientY;
        if (!raf) raf = requestAnimationFrame(flushPan);
      };
      const up = (e) => {
        if (!isPanning) return;
        isPanning = false;
        pending = { x: 0, y: 0 };
        setCursor(canvas, "grab");
        try {
          canvas.releasePointerCapture(e.pointerId);
        } catch (_) {}
      };
      canvas.addEventListener("pointerdown", down);
      canvas.addEventListener("pointermove", move);
      canvas.addEventListener("pointerup", up);
      canvas.addEventListener("pointerleave", up);
      panHandlers.set(canvas, { down, move, up });
    }

    function setError(msg) {
      const el = document.getElementById("error");
      if (!msg) {
        el.style.display = "none";
        el.textContent = "";
      } else {
        el.style.display = "block";
        el.textContent = msg;
      }
    }

    async function loadInfo(loadToken, ticker) {
      const info = await fetchJSON(`/api/info?ticker=${encodeURIComponent(ticker)}&t=${Date.now()}`);
      if (loadToken !== activeLoadToken) return;
      document.getElementById("infoName").textContent = info.name || "—";
      document.getElementById("infoSymbol").textContent = info.symbol ? info.symbol : "—";
      document.getElementById("infoSector").textContent = info.sector || "—";
      document.getElementById("infoIndustry").textContent = info.industry || "—";
      document.getElementById("infoPrice").textContent = formatUSD(info.currentPrice);
      document.getElementById("infoMarketCap").textContent = info.marketCap ? info.marketCap.toLocaleString("en-US") : "—";
      const range = (info.fiftyTwoWeekLow || "—") + " / " + (info.fiftyTwoWeekHigh || "—");
      document.getElementById("info52w").textContent = range;
      document.getElementById("infoWebsite").textContent = info.website || "—";
    }

    function renderHistoryTable(data) {
      const tbody = document.querySelector("#historyTable tbody");
      tbody.innerHTML = "";
      const rows = state.showFullHistory ? data : data.slice(-10);
      rows.forEach((p) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.Date}</td><td>${p.Open}</td><td>${p.High}</td><td>${p.Low}</td><td>${p.Close}</td><td>${p.Volume}</td>`;
        tbody.appendChild(tr);
      });
      const meta = document.getElementById("historyRowsMeta");
      const btn = document.getElementById("toggleHistoryRows");
      meta.textContent = state.showFullHistory ? `Showing all ${data.length}` : `Showing latest ${rows.length} of ${data.length}`;
      btn.textContent = state.showFullHistory ? "Show summary" : "Show all";
    }

    async function loadHistory(loadToken, ticker, range, interval) {
      const query = new URLSearchParams({
        ticker,
        range,
        t: Date.now().toString(),
      });
      if (interval && interval !== "auto") {
        query.set("interval", interval);
      }
      const data = await fetchJSON(`/api/history?${query.toString()}`);
      if (loadToken !== activeLoadToken) return;
      const prices = data.prices || [];
      state.historyData = prices;
      renderHistoryTable(prices);
      const intervalLabel = data.interval ? data.interval : interval === "auto" ? "auto" : interval || "auto";
      document.getElementById("priceMeta").textContent = `${data.symbol} • ${range.toUpperCase()} • ${intervalLabel} • ${prices.length} rows`;

      // Build price chart (close)
      const labels = prices.map((p) => p.Date);
      const closes = prices.map((p) => p.Close);
      if (priceChart) priceChart.destroy();
      const priceCanvas = document.getElementById("priceChart");
      const ctx = priceCanvas.getContext("2d");
      priceChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: `Close (${intervalLabel})`,
              data: closes,
              borderColor: "#0052cc",
              backgroundColor: "rgba(0,82,204,0.1)",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: { x: { ticks: { maxRotation: 0 } } },
          plugins: {
            legend: { display: true },
            zoom: zoomOptions(priceCanvas),
            crosshair: { enabled: true },
          },
        },
      });
      attachPanHandlers(priceChart, priceCanvas);
      const reset = document.getElementById("resetPriceZoom");
      reset.onclick = () => {
        if (priceChart) priceChart.resetZoom();
        setCursor(priceCanvas, "grab");
      };
    }

    function renderPredTable(validation) {
      const tbody = document.querySelector("#predTable tbody");
      tbody.innerHTML = "";
      const tableRows = [...validation].sort((a, b) => new Date(b.Date) - new Date(a.Date));
      const rows = state.showFullPred ? tableRows : tableRows.slice(0, 10);
      rows.forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.Date}</td><td>${formatUSD(row.Close)}</td><td>${formatUSD(row.Prediction)}</td>`;
        tbody.appendChild(tr);
      });
      const meta = document.getElementById("predRowsMeta");
      const btn = document.getElementById("togglePredRows");
      meta.textContent = state.showFullPred ? `Showing all ${tableRows.length}` : `Showing latest ${rows.length} of ${tableRows.length}`;
      btn.textContent = state.showFullPred ? "Show summary" : "Show all";
    }

    async function loadPrediction(loadToken, ticker) {
      const data = await fetchJSON(`/api/predict?ticker=${encodeURIComponent(ticker)}&t=${Date.now()}`);
      if (loadToken !== activeLoadToken) return;
      document.getElementById("predictionValue").textContent = formatUSD(data.predicted_next_close);
      document.getElementById("rmseValue").textContent = formatUSD(data.rmse);

      const validation = data.validation || [];
      state.validationData = validation;
      renderPredTable(validation);

      // Build prediction chart
      const labels = validation.map((d) => d.Date);
      const actual = validation.map((d) => d.Close);
      const preds = validation.map((d) => d.Prediction);
      if (predChart) predChart.destroy();
      const predCanvas = document.getElementById("predChart");
      const ctx = predCanvas.getContext("2d");
      predChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Actual",
              data: actual,
              borderColor: "#008f5d",
              backgroundColor: "rgba(0,143,93,0.12)",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
              fill: true,
            },
            {
              label: "Predicted",
              data: preds,
              borderColor: "#f4a11e",
              backgroundColor: "rgba(244,161,30,0.12)",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.25,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: { x: { ticks: { maxRotation: 0 } } },
          plugins: {
            legend: { display: true },
            zoom: zoomOptions(predCanvas),
            crosshair: { enabled: true },
          },
        },
      });
      attachPanHandlers(predChart, predCanvas);
      const reset = document.getElementById("resetPredZoom");
      reset.onclick = () => {
        if (predChart) predChart.resetZoom();
        setCursor(predCanvas, "grab");
      };
    }

    function renderOptions(list) {
      const dl = document.getElementById("symbolList");
      dl.innerHTML = "";
      list.forEach(({ symbol, name }) => {
        const opt = document.createElement("option");
        opt.value = symbol;
        opt.label = name;
        dl.appendChild(opt);
      });
    }

    async function loadQuickPicks() {
      try {
        const list = await fetchJSON(`/api/symbols?t=${Date.now()}`);
        quickPickList = list;
        renderOptions(list);
        const qp = document.getElementById("quickPicks");
        qp.innerHTML = "";
        list.forEach(({ symbol, name }) => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.innerHTML = `<span>${symbol}</span><span class="muted">${name}</span>`;
          chip.onclick = () => {
            state.ticker = symbol;
            tickerInput.value = symbol;
            loadAll();
          };
          qp.appendChild(chip);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function runSearch(query) {
      const seq = ++searchSeq;
      try {
        const results = await fetchJSON(`/api/search?q=${encodeURIComponent(query)}&t=${Date.now()}`);
        if (seq !== searchSeq) return;
        renderOptions(results);
      } catch (err) {
        console.error(err);
      }
    }

    async function loadAll() {
      state.ticker = (tickerInput.value.trim() || state.ticker || "").toUpperCase();
      tickerInput.value = state.ticker;
      state.interval = intervalSelect.value || "auto";
      activeLoadToken += 1;
      const loadToken = activeLoadToken;
      if (priceChart) {
        priceChart.destroy();
        priceChart = null;
      }
      if (predChart) {
        predChart.destroy();
        predChart = null;
      }
      document.querySelector("#historyTable tbody").innerHTML = "";
      document.querySelector("#predTable tbody").innerHTML = "";
      document.getElementById("priceMeta").textContent = "Loading...";
      document.getElementById("predictionValue").textContent = "—";
      document.getElementById("rmseValue").textContent = "—";
      state.historyData = [];
      state.validationData = [];
      setError("");
      try {
        await Promise.all([
          loadInfo(loadToken, state.ticker),
          loadHistory(loadToken, state.ticker, state.range, state.interval),
          loadPrediction(loadToken, state.ticker),
        ]);
      } catch (err) {
        console.error(err);
        setError(err.message || "Unknown error");
      }
    }

    tickerInput.value = state.ticker;
    loadQuickPicks().then(loadAll);
  </script>
</body>
</html>
